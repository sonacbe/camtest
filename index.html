<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Face Detection v0.8</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            color: white;
        }

        #input_video { display: none; }

        #output_canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* ì‹œì‘ ë²„íŠ¼ ë° ì•ˆë‚´ ì»¨í…Œì´ë„ˆ */
        .start-container {
            z-index: 10;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 16px;
            max-width: 80%;
        }

        button#startBtn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,123,255,0.4);
            transition: transform 0.2s;
        }
        button#startBtn:active { transform: scale(0.95); }

        .error-msg {
            color: #ff4444;
            margin-top: 15px;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .env-info {
            color: #aaa;
            margin-bottom: 20px;
            font-size: 0.85rem;
        }

        /* ì˜¤ë²„ë ˆì´ íŒ¨ë„ (ì˜ìƒ ìœ„ì— ëœ¸) */
        .overlay-panel {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 5;
            display: none; /* ì‹œì‘ ì „ì—” ìˆ¨ê¹€ */
        }
    </style>
</head>
<body>

    <div class="start-container" id="startScreen">
        <h2>ğŸ“· Face Detection v0.8</h2>
        <div class="env-info" id="envInfo">í™˜ê²½ í™•ì¸ ì¤‘...</div>
        <button id="startBtn">ì¹´ë©”ë¼ ì‹œì‘í•˜ê¸°</button>
        <div class="error-msg" id="errorMsg"></div>
    </div>

    <div class="overlay-panel" id="overlay">
        <div id="statusInfo" style="font-size:0.9rem;">ì´ˆê¸°í™” ì¤‘...</div>
    </div>

    <video id="input_video" playsinline webkit-playsinline></video>
    <canvas id="output_canvas"></canvas>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const startScreen = document.getElementById('startScreen');
        const errorMsg = document.getElementById('errorMsg');
        const envInfo = document.getElementById('envInfo');
        const overlay = document.getElementById('overlay');
        const statusInfo = document.getElementById('statusInfo');

        // 1. í™˜ê²½ ì§„ë‹¨ (HTTPS ì—¬ë¶€ í™•ì¸)
        function checkEnvironment() {
            const isSecure = window.isSecureContext;
            const protocol = location.protocol;
            const hostname = location.hostname;

            let msg = `í˜„ì¬ ì£¼ì†Œ: ${protocol}//${hostname}\n`;
            
            if (!isSecure && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                msg += "âš ï¸ ì£¼ì˜: HTTPSê°€ ì•„ë‹™ë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                envInfo.style.color = "#ffaa00";
            } else {
                msg += "âœ… ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸(Secure Context) í™•ì¸ë¨.";
                envInfo.style.color = "#00ff00";
            }
            envInfo.innerText = msg;
        }
        checkEnvironment();

        // 2. í™”ë©´ í¬ê¸° ì¡°ì •
        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 3. MediaPipe ì„¤ì •
        const faceDetection = new FaceDetection({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
        }});
        faceDetection.setOptions({ model: 'short', minDetectionConfidence: 0.5 });
        faceDetection.onResults(onResults);

        // 4. ê²°ê³¼ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // ì˜ìƒ ë¹„ìœ¨ì— ë§ì¶° ê·¸ë¦¬ê¸° (object-fit: cover êµ¬í˜„)
            const imgAspect = results.image.width / results.image.height;
            const canvasAspect = canvasElement.width / canvasElement.height;
            let drawW, drawH, offX, offY;

            if (imgAspect < canvasAspect) {
                drawW = canvasElement.width;
                drawH = canvasElement.width / imgAspect;
                offX = 0;
                offY = (canvasElement.height - drawH) / 2;
            } else {
                drawH = canvasElement.height;
                drawW = canvasElement.height * imgAspect;
                offX = (canvasElement.width - drawW) / 2;
                offY = 0;
            }

            canvasCtx.drawImage(results.image, offX, offY, drawW, drawH);

            if (results.detections.length > 0) {
                statusInfo.innerText = `ê°ì§€ë¨: ${results.detections.length}ëª…`;
                for (const detection of results.detections) {
                    const bbox = detection.boundingBox;
                    const x = offX + (bbox.xCenter * drawW) - (bbox.width * drawW / 2);
                    const y = offY + (bbox.yCenter * drawHeight) - (bbox.height * drawH / 2); // ì—¬ê¸° ì˜¤íƒ€ ìˆ˜ì • (drawHeight -> drawH)
                    const w = bbox.width * drawW;
                    const h = bbox.height * drawH;

                    canvasCtx.strokeStyle = "#00FF00";
                    canvasCtx.lineWidth = 4;
                    canvasCtx.strokeRect(x, y, w, h);
                }
            } else {
                statusInfo.innerText = "ì–¼êµ´ ì°¾ëŠ” ì¤‘...";
            }
            canvasCtx.restore();
        }

        // 5. ì¹´ë©”ë¼ ì‹œì‘ (ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰)
        startBtn.onclick = async () => {
            startBtn.disabled = true;
            startBtn.innerText = "ì—°ê²° ì¤‘...";
            errorMsg.innerText = "";

            try {
                // ê¶Œí•œ ìš”ì²­
                const constraints = { video: { facingMode: 'user', width: 1280, height: 720 }, audio: false };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // ì„±ê³µ ì‹œ UI ì „í™˜
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    startScreen.style.display = 'none'; // ì‹œì‘ í™”ë©´ ìˆ¨ê¹€
                    overlay.style.display = 'block';    // ì˜¤ë²„ë ˆì´ í‘œì‹œ
                    loop(); // ë¶„ì„ ë£¨í”„ ì‹œì‘
                };

            } catch (err) {
                console.error(err);
                startBtn.disabled = false;
                startBtn.innerText = "ë‹¤ì‹œ ì‹œë„";
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMsg.innerText = "âŒ ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ê¶Œí•œì„ ì´ˆê¸°í™”í•´ì£¼ì„¸ìš”.";
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMsg.innerText = "âŒ ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                } else {
                    errorMsg.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.name}\n${err.message}`;
                }
            }
        };

        async function loop() {
            if (!videoElement.paused && !videoElement.ended) {
                await faceDetection.send({image: videoElement});
                requestAnimationFrame(loop);
            }
        }
    </script>
</body>
</html>
